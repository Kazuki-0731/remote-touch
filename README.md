# RemoteTouch

iPhone/AndroidをmacOSのリモコンとして使用できるBluetooth Low Energy (BLE)接続アプリ。

## 概要

RemoteTouchは、スマートフォンをMacのワイヤレスリモコンとして使用できるアプリです。Bluetooth接続により、離れた場所からカーソル操作、プレゼンテーション、メディア再生コントロールを実現します。

### アーキテクチャ

```
┌─────────────────┐          BLE          ┌─────────────────┐
│  iOS / Android  │ ────────────────────► │     macOS       │
│   (リモコン側)    │  BLE Peripheral      │   (受信側)       │
│  タッチパッド操作  │  広告・コマンド送信   │  BLE Central    │
│                 │                      │  スキャン・接続  │
└─────────────────┘                      └─────────────────┘
```

**アーキテクチャの特徴:**
- iOS/Androidアプリが**BLE Peripheral**として広告
- macOSアプリが**BLE Central**としてスキャン・接続
- iOS/Androidからコマンド（タッチパッド操作、ボタンクリックなど）を送信
- macOSがコマンドを受信し、CGEvent APIでシステムイベントを生成

## セットアップ

### 必要要件

- **macOS**: macOS 12.0 (Monterey) 以上、macOS 15.0 (Sonoma) 推奨
  - ⚠️ **注意**: macOS 16.0 Beta以降では、BLE Central機能に制限がある場合があります
  - 安定した動作には macOS 15 (Sonoma) 以下を推奨
- **iOS**: iOS 15.0 以上
- **Android**: Android 5.0 (API 21) 以上、BLE対応デバイス
- **Flutter**: 3.0 以上
- **Bluetooth**: 両デバイスでBluetooth 4.0 (BLE) 以上をサポート

### インストール手順

#### 1. macOSアプリ（受信側）のセットアップ

```bash
# リポジトリをクローン
git clone <repository-url>
cd remote-touch

# 依存関係をインストール
flutter pub get
cd macos && pod install && cd ..

# macOSアプリをビルド・実行
flutter run -d macos
```

**重要**: 初回起動時に**アクセシビリティ権限**を許可してください。
- システム設定 > プライバシーとセキュリティ > アクセシビリティ
- RemoteTouchアプリを許可リストに追加

#### 2. iOS/Androidアプリ（リモコン側）のセットアップ

**iOS:**
```bash
cd ios && pod install && cd ..
flutter run -d <ios-device-id>
```

**Android:**
```bash
flutter run -d <android-device-id>
```

## 使い方

### 前提条件
1. **両方のデバイスでBluetoothがONになっていること**
2. **macOS側でアクセシビリティ権限が許可されていること**
3. **iOS/AndroidとmacOSが近くにあること**（BLE通信範囲: 約10m）

### 1. macOSアプリを起動

1. macOSで`flutter run -d macos`を実行
2. メニューバーにRemoteTouchアイコン（アンテナマーク）が表示されます
3. アプリは自動的にBLEスキャンを開始します（ステータス: 🔍 Scanning）
4. アイコンをクリックして「Show Connection Status」で接続状態を確認できます

### 2. iOS/Androidアプリで広告を開始

1. スマートフォンでRemoteTouchアプリを起動
2. アプリが自動的にBLE広告を開始します
3. macOSアプリがスマートフォンを検出すると、自動的に接続します
4. 接続が成功すると、メニューバーのアイコンが「Connected」状態に変わります（●マーク）

### 3. リモコン操作

#### タッチパッド操作
- **スワイプ**: カーソル移動
- **シングルタップ**: 左クリック
- **ダブルタップ**: ダブルクリック
- **2本指ピンチ**: ズーム（対応アプリのみ）

#### 物理ボタン
- **←ボタン**: 戻る / プレゼン時は前のスライド
- **→ボタン**: 決定 / プレゼン時は次のスライド

### 4. 操作モードの切り替え

**プレゼンテーションモード**
- スライド送り/戻しに最適化
- ←/→ボタンでスライド移動

**メディアコントロールモード**
- タップで再生/一時停止
- 上下スワイプで音量調整

**基本マウスモード**
- 標準的なマウス操作
- ←ボタン: Command+左矢印（戻る）
- →ボタン: Enter

### 5. 設定

**感度調整**
- 設定画面でタッチパッド感度を調整（0.5倍〜3.0倍）

**デバイス管理**
- 最大5台までのMacを登録可能
- デバイス一覧から簡単に切り替え

## アプリ概要

### 画面設計

```
┌─────────────────────────┐
│                         │
│   ┌─────────────────┐   │
│   │                 │   │
│   │                 │   │
│   │   タッチパッド   │   │
│   │   エリア        │   │
│   │                 │   │
│   │   (スワイプで    │   │
│   │    カーソル移動) │   │
│   │                 │   │
│   └─────────────────┘   │
│                         │
│   ┌─────┐   ┌─────┐    │
│   │  ←  │   │  →  │    │
│   │     │   │     │    │
│   └─────┘   └─────┘    │
│    戻る       決定      │
│                         │
│   接続状態: ● Mac mini  │
└─────────────────────────┘
```

### 主要機能

#### 3.1 タッチパッドコントロール
- **スワイプジェスチャー**: 上下左右のスワイプでカーソル移動
- **感度調整**: スワイプ速度に応じたカーソル移動速度の変更
- **タップ操作**: シングルタップでクリック、ダブルタップでダブルクリック
- **ピンチ操作**: 2本指ピンチでズームイン/アウト（対応アプリのみ）

#### 3.2 物理ボタン
- **←ボタン**:
  - ブラウザ/Finderで「戻る」操作
  - プレゼンテーション時はスライド前へ
- **→ボタン**:
  - 決定/Enter操作
  - プレゼンテーション時はスライド次へ

#### 3.3 BLE接続管理
- **自動再接続**: 範囲内にあるmacOSデバイスを自動検出
- **複数デバイス登録**: 最大5台までのMac登録・切り替え
- **接続状態表示**: リアルタイム接続ステータスとバッテリー情報

#### 3.4 プリセットモード
- **プレゼンテーションモード**: スライド操作に特化したUI
- **メディアコントロールモード**: 再生/一時停止/音量調整
- **基本マウスモード**: 標準的なマウス操作

### 技術スタック
- **フロントエンド**: Swift (iOS) / SwiftUI
- **Mac側ソフトウェア**: Swift (macOS) / AppKit
- **通信**: Core Bluetooth (BLE)
- **認証**: Bonjour + ペアリングコード
- **入力制御**: macOS CGEvent API

### 主要画面構成
1. デバイス選択画面（Mac一覧・ペアリング）
2. メインコントロール画面（タッチパッド）
3. モード選択画面（プレゼン/メディア/基本）
4. 設定画面（感度調整・ボタンカスタマイズ）

### ユースケース
- プレゼンテーション時にステージから操作
- ベッドからMac miniのメディア再生をコントロール
- リビングのテレビ接続Mac miniをソファから操作
- 会議室のプロジェクター接続Macを席から操作

### 技術的課題と解決策
- **レイテンシ対策**: BLE 4.2以上での低遅延通信
- **セキュリティ**: ペアリング時のワンタイムコード認証
- **省電力**: アイドル時の自動スリープ機能
- **macOS権限**: アクセシビリティ権限の適切な取得フロー

## トラブルシューティング

### macOS側

**Q: メニューバーにアイコンが表示されない**
- A: アプリを再起動してください。`flutter run -d macos`で再実行

**Q: 「Bluetooth unsupported」エラーが表示される**
- A1: **macOS ベータ版の制限**: macOS 16.0 Beta以降では、BLE Central機能に制限がある場合があります
  - 対処法1: macOS 15 (Sonoma) 以下の安定版を使用
  - 対処法2: 実機（iPhone/Android）でテストする
  - 対処法3: 別のMacデバイスでテストする
- A2: Bluetooth権限を確認:
  - システム設定 > プライバシーとセキュリティ > Bluetooth
  - RemoteTouchにBluetooth使用を許可
- A3: Bluetoothをオフ/オンで再起動

**Q: ステータスが「Disconnected」のまま**
- A1: iOS/Androidアプリが起動しているか確認
- A2: 両デバイスのBluetoothがONになっているか確認
- A3: デバイスが近くにあるか確認（通信範囲: 約10m）
- A4: macOSアプリを再起動して再度スキャン

**Q: カーソルが動かない**
- A: アクセシビリティ権限が許可されているか確認
  - システム設定 > プライバシーとセキュリティ > アクセシビリティ
  - RemoteTouchがリストにあり、チェックが入っているか確認

**Q: ペアリングコードが表示されない**
- A: メニューバーアイコン > 「ペアリングコードを表示」を選択

### iOS/Android側

**Q: デバイスが検出されない**
- A1: Bluetooth権限が許可されているか確認
- A2: macOSアプリが起動しているか確認
- A3: スマートフォンのBluetoothがONになっているか確認
- A4: 「デバイスをスキャン」を再度タップ

**Q: 接続が頻繁に切れる**
- A1: デバイス間の距離を近づける（BLE通信範囲は約10m）
- A2: 両デバイスを再起動
- A3: 設定から自動再接続がONになっているか確認

**Q: 感度が合わない**
- A: 設定画面で感度を調整（0.5倍〜3.0倍）

## 開発情報

### プロジェクト構成

```
remote-touch/
├── lib/                    # Flutter/Dartコード（iOS/Android共通）
│   ├── models/            # データモデル
│   ├── services/          # BLE通信、ジェスチャー処理
│   ├── viewmodels/        # ビジネスロジック
│   └── views/             # UI
├── macos/                 # macOS固有コード
│   └── Runner/
│       ├── Services/      # BLE Peripheral、イベント生成
│       └── Models/        # データモデル
├── ios/                   # iOS設定
└── android/               # Android設定
```

### ビルド

**デバッグビルド:**
```bash
flutter run -d macos        # macOS
flutter run -d <device-id>  # iOS/Android
```

**リリースビルド:**
```bash
flutter build macos --release
flutter build ios --release
flutter build apk --release
```

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 貢献

プルリクエストを歓迎します。大きな変更の場合は、まずissueを開いて変更内容を議論してください。

